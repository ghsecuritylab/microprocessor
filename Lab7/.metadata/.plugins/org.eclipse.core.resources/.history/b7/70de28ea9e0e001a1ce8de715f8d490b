#include "stm32l476xx.h"
#include "utils.h"

int plln = 40, pllm = 7, prescaler = 0; // 10 MHz SYSCLK
int prev_btn = 1, curr_btn = 1;

void SystemClock_Config();
void SysTick_Config();
void SysTick_Handler();

int main()
{
	SystemClock_Config();
	SysTick_UserConfig();
	gpio_init();
	while (1)
	{
		if (!prev_btn && curr_btn){
			SysTick->CTRL = (SysTick->CTRL & 0xFFFFFFFE) | ~(SysTick->CTRL & 0x00000001);
		}
		prev_btn = curr_btn;
		curr_btn = GPIO_ReadInputDataBit(GPIOC, GPIO_Pin_13);
	}
}

void SystemClock_Config_source(void){
// turn on HSI16 oscillator
//check HSI16 ready
//SYSCLK divide by 16.
// Use HSI16 as system clock
}
void SysTick_Config(uint32_t ticks){
// set reload register
// Load the SysTick Counter Value
// CLKSOURCE processor clock
}

void SysTick_UserConfig()
{
	SysTick->CTRL |= 0x00000004;
	SysTick->LOAD = 60000000; // 0.5 second
	SysTick->VAL = 0;
	SysTick->CTRL |= 0x00000003;
}

void SysTick_Handler()
{
	GPIOA->ODR = (GPIOA->ODR & 0xFFFFFFDF) | ~(GPIOA->ODR & 0x00000020);
}
